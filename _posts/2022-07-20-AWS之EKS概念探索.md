---
title: 003_AWS之EKS概念探索
date: '2022-07-20 16:12:00 +0800'
categories: [Cloud]
tags: [AWS,Kubernetes]     # TAG names should always be lowercase
author: owen
mermaid: true
math: true
---

# 起源
在想要進一步透過 terraform 配置 AWS EKS 叢集的相關設定時，對於在使用場景和部分名詞定義上的觀念有模糊不清且對其具體影響也不了解，故留下此篇文章來加強自己對於 EKS 這個服務的功能更進一步的了解並在往後合適的時機能夠加以應用。

# 關於 node 的種類及其差異
總的來說，node 種類分為三種。分別是 self-managed、managed、fargate。而參考過各種資料後，自己理解是「差別在於對 kubernetes 的 control plane 控制權(又或是控制的程度)」。
AWS 具體的差異比對 <https://docs.aws.amazon.com/zh_tw/eks/latest/userguide/eks-compute.html>
- self-managed : 對於 control plane 有最大的控制，基本上對於 AWS 來說，AWS 認為採用此種類屬於用戶自己管理整個 kubernetes，因為 AWS 並不會干涉用戶創建的任何資源和方式。
- managed : 對於 control plane 有一定程度的干涉，並且因為有干涉所以對於部署方式及配置有一定程度的限制。但也因為如此，所以 AWS 把這種節點的 ec2 instance 幫忙管理，也會在更新時遵循用戶的配置將 instance 和 pod 做控管。
- fargate : 基本上對用戶來說就是看不到 instance，因為這種模式需要直接定義一個稱為 「fargate profile」的設定檔，只要遵循該設定啟動的 pods，都會用 fargate 的形式部署，與前面兩種最大的差異是它是按 vCPU/硬碟 收費的。並且因為用戶只能管 pods，所以滿多限制條件。但好處是可以最大程度的做到資源利用。(因為無 instance 所以又稱為 serverless)

## 小結
基本上 managed 和 self-managed 都是一樣的費用，它是按 instance 資源的收費標準。所以機器規格多大、用多少硬碟等等的就直接是這兩種的費用。

但因為兩者之間對於 control plane 還是有些許差異，所以目前讀起來感受的最大差異應該是在「如果要用 dedicated host(專用主機)」來部署 EKS，則就必須要用 self-managed 的方式。managed 不提供 dedicated host 部署。

另外像是 managed 也不提供 windows container 和 用 local zone 部署，但不知道未來有沒有機會開放。

# 關於 AWS EKS 的 Pods 限制
AWS EKS 在預設情況下，對於 Pods 部署的數量是有限制的，公式為 ENI * (可用私有IP數量 - 1) + 2。

而每個 instance type 能夠用的 ENI 數量和可用私有 IP 數量限制可以參考 <https://docs.aws.amazon.com/zh_tw/AWSEC2/latest/UserGuide/using-eni.html#AvailableIpPerENI>

舉例來說一台 t3a.large 最多可以部署的 pods 總數量為 「3 * (12-1) + 2」 = 35

# 關於 EKS 的 Addons (附加元件)
因為 terraform 的範例有段配置 addons 的相關設定，故自己往下瞭解。發現 AWS EKS 在自己初始化的時候就會安裝基本的 addons 來確保 cluster 在建置完成後就可以使用基本功能，而這些 addons 是基於 AWS Cloud 的配置，故部分 addons 功能是必要的。

參考 addons 說明 <https://docs.aws.amazon.com/zh_tw/eks/latest/userguide/eks-add-ons.html>

像是 VPC CNI / CoreDNS / kube-proxy 這三個在用 EKS 搭建的時候就會自己安裝。
- VPC CNI : 讓 kubernetes 內的 pod 可以直接與 VPC 上的 IP 一樣
- CoreDNS : 提供 kubernetes 內的 pod 做 DNS 解析
- kube-proxy : 會維護每個 Amazon EC2 節點上的網路規則。它使網路能與您的 Pod 進行通訊。

> 以上情況是 managed / self-managed 的情況，若用 Fargate 情況會不太一樣
{: .prompt-info }

# 關於 EKS 的 auto scale 設定機制 - 尚未完讀
參考 <https://docs.aws.amazon.com/zh_tw/eks/latest/userguide/autoscaling.html#ca-deployment-considerations>


# 參考資料
[曾經參考此影片說明其 node 種類差異](https://www.youtube.com/watch?v=yde16HpQIRo&ab_channel=BoltOps)
[關於 Pods 聯網說明 - 在 VPC CNI 的閱讀中有提到 pods 限制的問題](https://docs.aws.amazon.com/zh_tw/eks/latest/userguide/pod-networking.html)